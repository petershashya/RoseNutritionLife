{% extends 'layout.html' %}

{% block content %}
{% load static %}
{% load crispy_forms_tags %}

<style>
  .message {
      color: purple;
  }

  /* Password input and show/hide button */
  .password-container {
      position: relative;
  }

  .password-container input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
  }

  .password-container .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      user-select: none;
  }

  /* Strength indicator bar */
  .strength-meter {
      height: 5px;
      background-color: #ddd;
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
  }

  .strength-meter-fill {
      height: 100%;
      width: 0;
      border-radius: 5px;
      transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
  }

  /* Strength level colors */
  .weak {
      background-color: red;
  }

  .medium {
      background-color: orange;
  }

  .strong {
      background-color: green;
  }

</style>

<section class="book_section layout_padding mt-5" id="details">
    <div class="row">
      <div class="col">
        <div class="container ">

          <form method="post">
            {% csrf_token %}
            <h4>
              CHANGE<span> PASSWORD</span>
            </h4>
            
            <span class="text-warning"> For strong password! add letters, numbers, and characters</span>
            <div class="form-row">
              <div class="form-group col-lg-4 password-container">
                  <label for="new_password">New Password</label>
                  <input type="password" class="form-control" name="new_password" id="new_password" placeholder="New password">
                  <span class="toggle-password mt-2 mx-2"><i class="bi bi-eye-fill"></i></span>
                  <div class="strength-meter">
                      <div class="strength-meter-fill" id="new-password-strength"></div>
                  </div>
              </div>
          </div>
      
          <div class="form-row">
              <div class="form-group col-lg-4 password-container">
                  <label for="confirm_password">Confirm Password</label>
                  <input type="password" class="form-control" name="confirm_password" id="confirm_password" placeholder="Confirm password">
                  <span class="toggle-password mt-2 mx-2"><i class="bi bi-eye-fill"></i></span>
                  <div class="strength-meter">
                      <div class="strength-meter-fill" id="confirm-password-strength"></div>
                  </div>
              </div>
          </div>
            

            {% if error %}
              <p style="color: red;">{{ error }}</p>
            {% endif %}

            <div class="btn-box">
              <button type="submit" class="btn btn-sm bg-secondary text-white">Save</button>
              <a href="{% url 'forgot_password' %}" class="btn btn-sm text-secondary bg-light p-2 mt-3">Back</a>
            </div> 
          </form>
        </div>
      </div>
    </div>
</section>

<script>
  // Show/hide password functionality with icons
  document.querySelectorAll('.toggle-password').forEach(toggle => {
      toggle.addEventListener('click', function () {
          const input = this.previousElementSibling;
          const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
          input.setAttribute('type', type);
          this.innerHTML = type === 'password' ? '<i class="bi bi-eye-fill"></i>' : '<i class="bi bi-eye-slash-fill"></i>';
      });
  });

  // Password strength checker
  const newPasswordInput = document.getElementById('new_password');
  const confirmPasswordInput = document.getElementById('confirm_password');
  const newPasswordStrength = document.getElementById('new-password-strength');
  const confirmPasswordStrength = document.getElementById('confirm-password-strength');

  newPasswordInput.addEventListener('input', function () {
      checkPasswordStrength(newPasswordInput.value, newPasswordStrength);
  });

  confirmPasswordInput.addEventListener('input', function () {
      checkPasswordStrength(confirmPasswordInput.value, confirmPasswordStrength);
  });

  function checkPasswordStrength(password, strengthMeter) {
      let strength = 0;

      if (password.length > 7) strength += 1;
      if (/[A-Z]/.test(password)) strength += 1;
      if (/[0-9]/.test(password)) strength += 1;
      if (/[@$!%*?&]/.test(password)) strength += 1;

      updateStrengthMeter(strength, strengthMeter);
  }

  function updateStrengthMeter(strength, strengthMeter) {
      strengthMeter.style.width = strength * 25 + '%';

      if (strength === 0) {
          strengthMeter.className = 'strength-meter-fill';
      } else if (strength === 1) {
          strengthMeter.className = 'strength-meter-fill weak';
      } else if (strength === 2) {
          strengthMeter.className = 'strength-meter-fill medium';
      } else if (strength > 2) {
          strengthMeter.className = 'strength-meter-fill strong';
      }
  }
</script>
{% endblock %}
